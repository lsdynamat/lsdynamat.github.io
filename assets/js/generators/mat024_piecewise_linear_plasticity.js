// assets/js/generators/mat024_piecewise_linear_plasticity.js
// MAT_024: Yun & Gardner (2017)
// Engineering envelope → true stress/strain → true plastic strain curve
// Horizontal tail added at eps_p(peak) + Δeps_p to avoid solver extrapolation
//
// References:
// Yun, X. & Gardner, L. (2017). JCSR 133, 36–46. DOI: 10.1016/j.jcsr.2017.01.024
// Han et al. (2025). Structures 71, 107930. DOI: 10.1016/j.istruc.2024.107930
//
// Units: mm–ms–g–N–MPa

export const KEY = "mat024_piecewise_linear_plasticity";
export const ID = 24;
export const NAME = "Piecewise Linear Plasticity";
export const CATEGORY = "Metals";
export const UNITS = "mm-ms-g-N-MPa";

const HUB_LINE = "$ Generated by LS DYNA Material Hub https://lsdynamat.github.io/";
const UNITS_LINE = "$ Units: mm-ms-g-N-MPa";
const MODEL_LINE = "$ Model: MAT_024 Piecewise Linear Plasticity (Yun & Gardner)";

const REF_LINES = [
  "$ Yun, X., & Gardner, L. (2017). Stress–strain curves for hot-rolled steels.",
  "$ Journal of Constructional Steel Research, 133, 36–46.",
  "$ DOI: 10.1016/j.jcsr.2017.01.024",
  "$ Han, et al. (2025). Structures, 71, 107930.",
  "$ DOI: 10.1016/j.istruc.2024.107930",
];

const MATERIAL_CARDS_BANNER = [
  "$ --+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8",
  "$                                                                              $",
  "$                                MATERIAL CARDS                                $",
  "$                                                                              $",
  "$ --+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8",
];

// Elastic discretization (internal, hidden)
const N_ELASTIC_INTERNAL = 12;

export const DEFAULTS = {
  mid: 1,

  ro: 0.00785,
  E: 210000,
  pr: 0.30,

  fy: 235,
  fu: 360,

  // USER-controlled discretization
  n_plateau: 6,
  n_hardening: 25,

  // Tail length in true plastic strain
  tail_d_epsp: 0.1,
};

export const FIELDS = [
  { key: "mid", label: "Material ID (MID)", unit: "-", default: 1, min: 1 },

  { key: "ro", label: "Density RO", unit: "g/mm^3", default: 0.00785 },
  { key: "E", label: "Young's modulus E", unit: "MPa", default: 210000 },
  { key: "pr", label: "Poisson ratio PR", unit: "-", default: 0.30, min: 0, max: 0.499 },

  { key: "fy", label: "Yield stress Fy", unit: "MPa", default: 235 },
  { key: "fu", label: "Ultimate stress Fu", unit: "MPa", default: 360 },

  {
    key: "n_plateau",
    label: "Points: yield plateau",
    unit: "-",
    default: 6,
    min: 3,
    hint: "Number of interpolation points on the yield plateau (σ = Fy). Affects smoothness only."
  },
  {
    key: "n_hardening",
    label: "Points: hardening",
    unit: "-",
    default: 25,
    min: 10,
    hint: "Number of interpolation points for nonlinear hardening (Fy → Fu). Affects smoothness only."
  },
  {
    key: "tail_d_epsp",
    label: "Tail length Δεp after peak",
    unit: "-",
    default: 0.1,
    min: 0,
    hint: "Adds one final point at εp(peak)+Δεp with constant peak stress to avoid extrapolation."
  }
];

export function generate(input = {}) {
  const inp = { ...DEFAULTS, ...input };

  const mid = +inp.mid;
  const ro = +inp.ro;
  const E  = +inp.E;
  const pr = +inp.pr;
  const fy = +inp.fy;
  const fu = +inp.fu;

  const n_plateau   = Math.max(3, Math.trunc(inp.n_plateau));
  const n_hardening = Math.max(10, Math.trunc(inp.n_hardening));
  const tail_d_epsp = Math.max(0, +inp.tail_d_epsp);

  // --- Yun & Gardner parameters (engineering strain) ---
  const eps_y = fy / E;

  const eps_sh = Math.min(
    0.03,
    Math.max(0.015, 0.1 * (fy / fu) - 0.055)
  );

  const eps_u = Math.max(
    0.06,
    0.6 * (1.0 - fy / fu)
  );

  // --- Elastic (internal) ---
  let eps_el = linspace(0, eps_y, N_ELASTIC_INTERNAL).slice(0, -1);
  let sig_el = eps_el.map(e => E * e);

  // --- Yield plateau ---
  let eps_pl = linspace(eps_y, eps_sh, n_plateau).slice(0, -1);
  let sig_pl = eps_pl.map(() => fy);

  // --- Hardening ---
  let eps_h = linspace(eps_sh, eps_u, n_hardening);
  let sig_h = eps_h.map(e => {
    const C = (e - eps_sh) / (eps_u - eps_sh);
    const D = Math.pow(1 + 400 * Math.pow(C, 5), 0.2);
    return fy + (fu - fy) * (0.4 * C + 2 * C / D);
  });

  const eng_eps = eps_el.concat(eps_pl, eps_h);
  const eng_sig = sig_el.concat(sig_pl, sig_h);

  // --- True stress / strain ---
  const tru_eps = eng_eps.map(e => Math.log1p(e));
  const tru_sig = eng_sig.map((s, i) => s * (1 + eng_eps[i]));

  // --- True plastic strain ---
  let eps_p = tru_eps.map((e, i) => Math.max(0, e - tru_sig[i] / E));

  const i0 = eng_sig.findIndex(s => s >= fy);
  eps_p = eps_p.slice(i0);
  let sig_true = tru_sig.slice(i0);

  const ep0 = eps_p[0];
  eps_p = eps_p.map((v, i) => (i === 0 ? 0 : v - ep0));

  // --- Peak stress ---
  let ipk = sig_true.indexOf(Math.max(...sig_true));
  const sig_pk = sig_true[ipk];

  eps_p = eps_p.slice(0, ipk + 1);
  sig_true = sig_true.slice(0, ipk + 1);

  // --- Horizontal tail ---
  eps_p.push(eps_p[eps_p.length - 1] + tail_d_epsp);
  sig_true.push(sig_pk);

  // --- Output ---
  const lcss = mid * 1000 + 24;

  const titleLine = `MAT_024 YunGardner Fy=${fy}MPa Fu=${fu}MPa`;
  const curveTitle = `LCSS_${lcss} Fy=${fy} Fu=${fu}`;

  const lines = [];
  lines.push("*KEYWORD");
  MATERIAL_CARDS_BANNER.forEach(l => lines.push(l));
  lines.push(UNITS_LINE);
  lines.push(MODEL_LINE);
  REF_LINES.forEach(l => lines.push(l));
  lines.push(HUB_LINE);

  lines.push("*DEFINE_CURVE_TITLE");
  lines.push(curveTitle);
  lines.push("$#    LCID      SIDR       SFA       SFO      OFFA      OFFO");
  lines.push(fmt(lcss) + fmt(0) + fmt(1) + fmt(1) + fmt(0) + fmt(0));
  lines.push("$#                a               o");
  eps_p.forEach((e, i) => lines.push(fmt20(e) + fmt20(sig_true[i])));

  lines.push("*MAT_PIECEWISE_LINEAR_PLASTICITY_TITLE");
  lines.push(titleLine);
  lines.push("$#     MID        RO         E        PR      SIGY      ETAN      FAIL      TDEL");
  lines.push(fmt(mid) + fmt(ro) + fmt(E) + fmt(pr) + fmt(fy) + fmt(0) + fmt(0) + fmt(0));
  lines.push("$#       C        P      LCSS      LCSR        VP");
  lines.push(fmt(0) + fmt(0) + fmt(lcss) + fmt(0) + fmt(0));

  lines.push("*END");

  return {
    filename: `MAT_024_YunGardner_Fy${fy}_Fu${fu}.k`,
    keyword: lines.join("\n")
  };
}

/* helpers */
function linspace(a, b, n) {
  return Array.from({ length: n }, (_, i) => a + (b - a) * i / (n - 1));
}
function fmt(v) {
  return String(v).padStart(10, " ");
}
function fmt20(v) {
  return String(v.toExponential(6).replace("e", "E")).padStart(20, " ");
}
