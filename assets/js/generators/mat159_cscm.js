// assets/js/generators/mat159_cscm.js
// CSCM Generator (LS-DYNA *MAT_CSCM)

export const KEY = "mat159_cscm";
export const ID = 159;
export const NAME = "CSCM Concrete (*MAT_CSCM)";
export const CATEGORY = "Concrete";
export const UNITS = "mm-ms-g-N-MPa";

const HUB_LINE = "$ Generated by LS DYNA Material Hub http://lsdynamat.github.io";
const UNITS_LINE = "$ Units: mm-ms-g-N-MPa";

export const DEFAULTS = {
  fc_mpa: 30.0,
  dmax_mm: 16.0,
  mid: 1001,

  ro: 0.0023,
  nplot: 1,
  incre: 0.0,
  irate: 0,
  erode: 1.05,
  recov: 0.0,
  itretrc: 0,
  pred: 0.0,

  poisson_ratio: 0.2,
  w: 0.065,
  d1: 0.000611,
  d2: 0.000002,
  B: 100.0,
  D: 0.1,
  PWRC: 5.0,
  PWRT: 1.0,
  PMOD: 0.0,
  nh: 0.0,
  ch: 0.0,
};

export const FIELDS = [
  { key: "fc_mpa", label: "Compressive strength (fc)", unit: "MPa", type: "number", step: 0.1, min: 1, default: DEFAULTS.fc_mpa },
  { key: "dmax_mm", label: "Max aggregate size (dmax)", unit: "mm", type: "number", step: 0.1, min: 1, default: DEFAULTS.dmax_mm },
  { key: "mid", label: "Material ID (MID)", unit: "-", type: "integer", step: 1, min: 1, default: DEFAULTS.mid },

  { key: "ro", label: "Density (RO)", unit: "g/mm^3", type: "number", step: 0.0001, min: 0.0001, default: DEFAULTS.ro },
  { key: "erode", label: "ERODE", unit: "-", type: "number", step: 0.01, min: 0, default: DEFAULTS.erode },
  { key: "poisson_ratio", label: "Poisson ratio (PR)", unit: "-", type: "number", step: 0.01, min: 0, max: 0.49, default: DEFAULTS.poisson_ratio },

  { key: "w", label: "W", unit: "-", type: "number", step: 0.001, default: DEFAULTS.w, advanced: true },
  { key: "d1", label: "D1", unit: "-", type: "number", step: 0.000001, default: DEFAULTS.d1, advanced: true },
  { key: "d2", label: "D2", unit: "-", type: "number", step: 0.000001, default: DEFAULTS.d2, advanced: true },
  { key: "B", label: "B", unit: "-", type: "number", step: 1, default: DEFAULTS.B, advanced: true },
  { key: "D", label: "D", unit: "-", type: "number", step: 0.01, default: DEFAULTS.D, advanced: true },
  { key: "PWRC", label: "PWRC", unit: "-", type: "number", step: 1, default: DEFAULTS.PWRC, advanced: true },
  { key: "PWRT", label: "PWRT", unit: "-", type: "number", step: 1, default: DEFAULTS.PWRT, advanced: true },
  { key: "PMOD", label: "PMOD", unit: "-", type: "number", step: 1, default: DEFAULTS.PMOD, advanced: true },
];

export function generate(input = {}) {
  const inp = { ...DEFAULTS, ...input };

  inp.fc_mpa = mustPositive("fc_mpa", inp.fc_mpa);
  inp.dmax_mm = mustPositive("dmax_mm", inp.dmax_mm);
  inp.mid = mustIntPositive("mid", inp.mid);

  const p = computeParams(inp);
  const keyword = renderKeyword(inp, p);

  const filename = `MAT_CSCM_fc${toFixed(inp.fc_mpa, 1)}_dmax${toFixed(inp.dmax_mm, 1)}_mid${inp.mid}.k`;

  return { filename, keyword };
}

// ------------------------
// validation helpers
// ------------------------
function mustPositive(name, x) {
  const v = Number(x);
  if (!Number.isFinite(v)) throw new Error(`${name} must be a number`);
  if (v <= 0) throw new Error(`${name} must be > 0`);
  return v;
}
function mustIntPositive(name, x) {
  const v = Number(x);
  if (!Number.isFinite(v)) throw new Error(`${name} must be a number`);
  const vi = Math.trunc(v);
  if (vi <= 0) throw new Error(`${name} must be an integer > 0`);
  return vi;
}
function toFixed(x, n) {
  const v = Number(x);
  if (!Number.isFinite(v)) return String(x);
  return v.toFixed(n);
}
function fmt10(x, decimals = 6) {
  if (Number.isInteger(x)) return String(x).padStart(10, " ");
  const v = Number(x);
  if (!Number.isFinite(v)) return String(x).padStart(10, " ");
  const av = Math.abs(v);
  if (av !== 0 && (av >= 1e6 || av < 1e-4)) {
    return v.toExponential(3).replace("e", "E").padStart(10, " ");
  }
  return v.toFixed(decimals).padStart(10, " ");
}

// ------------------------
// math (ported from your Python source-of-truth)
// ------------------------
function calculateFractureEnergy(fc_mpa, dmax_mm) {
  const delta_f = 8.0;
  const fcm = fc_mpa + delta_f;
  const fcm0 = 10.0;
  const gf0 = 0.021 + 5.357e-4 * dmax_mm;
  const gf = gf0 * Math.pow(fcm / fcm0, 0.7);
  return { gf0, gf };
}
function calculateModulus(fc_mpa, poisson_ratio) {
  const Ec0 = 21.5e3;
  const delta_f = 8.0;
  const fcm = fc_mpa + delta_f;
  const fcm0 = 10.0;
  const E = Ec0 * Math.pow((fcm + delta_f) / fcm0, 1.0 / 3.0);
  const G = E / (2.0 * (1.0 + poisson_ratio));
  const K = E / (3.0 * (1.0 - 2.0 * poisson_ratio));
  return { G, K };
}
function calculateAlphaBeta(fc_mpa) {
  const alpha = 13.9846 * Math.exp(fc_mpa / 68.8756) - 13.8981;
  const theta = 0.3533 - 3.3294e-4 * fc_mpa - 3.8182e-6 * (fc_mpa ** 2);
  const lamda = 3.6657 * Math.exp(fc_mpa / 39.9363) - 4.7092;
  const beta = 18.17791 * (fc_mpa ** -1.7163);

  const alpha1 = 0.82, theta1 = 0.0, lamda1 = 0.24;
  const beta1 = 0.33565 * (fc_mpa ** -0.95383);

  const alpha2 = 0.76, theta2 = 0.0, lamda2 = 0.26;
  const beta2 = 0.285 * (fc_mpa ** -0.94843);

  return { alpha, theta, lamda, beta, alpha1, theta1, lamda1, beta1, alpha2, theta2, lamda2, beta2 };
}
function calculateAdditionalParameters(fc_mpa) {
  const fpsi = fc_mpa * 145.038;
  const eta0c = (1.2772337e-11 * (fpsi ** 2) - 1.0613722e-7 * fpsi + 3.203497e-4);
  const nc = 0.78;

  const eta0t = (8.0614774e-13 * (fc_mpa ** 2) - 9.77736719e-10 * fc_mpa + 5.0752351e-5);
  const nt = 0.48;

  const overc = 1.309663e-2 * (fc_mpa ** 2) - 0.3927659 * fc_mpa + 21.45;
  const overt = overc;

  const srate = 1.0;
  const repow = 1.0;
  return { eta0c, nc, eta0t, nt, overc, overt, srate, repow };
}
function calculateRXd(fc_mpa) {
  const r = 4.45994 * Math.exp(-fc_mpa / 11.51679) + 1.95358;
  const xd = 17.087 + 1.892 * fc_mpa;
  return { r, xd };
}
function computeParams(inp) {
  const { gf0, gf } = calculateFractureEnergy(inp.fc_mpa, inp.dmax_mm);
  const { G, K } = calculateModulus(inp.fc_mpa, inp.poisson_ratio);
  const ab = calculateAlphaBeta(inp.fc_mpa);
  const { r, xd } = calculateRXd(inp.fc_mpa);
  const add = calculateAdditionalParameters(inp.fc_mpa);

  const gfc = 100.0 * gf;
  const gft = gf;
  const gfs = gf;

  return { gf0, gf, g: G, k: K, ...ab, r, xd, ...add, gfc, gft, gfs };
}

// ------------------------
// keyword renderer
// ------------------------
function renderKeyword(inp, p) {
  const title = `MAT_CSCM_fc${toFixed(inp.fc_mpa, 1)}MPa_dmax${toFixed(inp.dmax_mm, 1)}mm`;

  const lines = [];
  lines.push("$# ------------------------------------------------------------------------------");
  lines.push(UNITS_LINE);
  lines.push(HUB_LINE);
  lines.push("$# ------------------------------------------------------------------------------");
  lines.push("*KEYWORD");
  lines.push("*TITLE");
  lines.push("$#                                                                         title");
  lines.push("LS-DYNA keyword deck generated by LS DYNA Material Hub");
  lines.push("*MAT_CSCM_TITLE");
  lines.push(title);

  lines.push("$#     mid        ro     nplot     incre     irate     erode     recov   itretrc");
  lines.push(
    `${fmt10(inp.mid)}` +
    `${fmt10(inp.ro, 4)}` +
    `${fmt10(inp.nplot)}` +
    `${fmt10(inp.incre, 1)}` +
    `${fmt10(inp.irate)}` +
    `${fmt10(inp.erode, 2)}` +
    `${fmt10(inp.recov, 1)}` +
    `${fmt10(inp.itretrc)}`
  );

  lines.push("$#    pred");
  lines.push(`${fmt10(inp.pred, 1)}`);

  lines.push("$#       g         k     alpha     theta     lamda      beta        nh        ch");
  lines.push(
    `${fmt10(p.g, 1)}` +
    `${fmt10(p.k, 1)}` +
    `${fmt10(p.alpha, 4)}` +
    `${fmt10(p.theta, 7)}` +
    `${fmt10(p.lamda, 5)}` +
    `${fmt10(p.beta, 7)}` +
    `${fmt10(inp.nh, 1)}` +
    `${fmt10(inp.ch, 1)}`
  );

  lines.push("$#  alpha1    theta1    lamda1     beta1    alpha2    theta2    lamda2     beta2");
  lines.push(
    `${fmt10(p.alpha1, 2)}` +
    `${fmt10(p.theta1, 1)}` +
    `${fmt10(p.lamda1, 2)}` +
    `${fmt10(p.beta1, 6)}` +
    `${fmt10(p.alpha2, 2)}` +
    `${fmt10(p.theta2, 1)}` +
    `${fmt10(p.lamda2, 2)}` +
    `${fmt10(p.beta2, 7)}`
  );

  lines.push("$#       r        xd         w        d1        d2");
  lines.push(
    `${fmt10(p.r, 5)}` +
    `${fmt10(p.xd, 3)}` +
    `${fmt10(inp.w, 3)}` +
    `${fmt10(inp.d1, 6)}` +
    `${fmt10(inp.d2, 6)}`
  );

  lines.push("$#       b       gfc         d       gft       gfs      pwrc      pwrt      pmod");
  lines.push(
    `${fmt10(inp.B, 1)}` +
    `${fmt10(p.gfc, 1)}` +
    `${fmt10(inp.D, 1)}` +
    `${fmt10(p.gft, 2)}` +
    `${fmt10(p.gfs, 2)}` +
    `${fmt10(inp.PWRC, 1)}` +
    `${fmt10(inp.PWRT, 1)}` +
    `${fmt10(inp.PMOD, 1)}`
  );

  lines.push("$#   eta0c        nc     etaot        nt     overc     overt     srate     rep0w");
  lines.push(
    `${fmt10(p.eta0c, 7)}` +
    `${fmt10(p.nc, 2)}` +
    `${fmt10(p.eta0t, 7)}` +
    `${fmt10(p.nt, 2)}` +
    `${fmt10(p.overc, 5)}` +
    `${fmt10(p.overt, 5)}` +
    `${fmt10(p.srate, 1)}` +
    `${fmt10(p.repow, 1)}`
  );

  lines.push("*END");
  lines.push("");
  return lines.join("\n");
}
