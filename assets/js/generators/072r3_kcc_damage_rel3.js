function padLeft(s, w) {
  s = String(s);
  return s.length >= w ? s : " ".repeat(w - s.length) + s;
}
function fmtInt(x, w = 10) {
  return padLeft(String(Math.trunc(Number(x) || 0)), w);
}
function fmtExp(x, p = 3, w = 10) {
  const v = Number.isFinite(x) ? x : 0;
  let s = v.toExponential(p).replace("e", "E");
  return padLeft(s, w);
}

export function genMAT072R3_KCC_REL3(p) {
  const mid = Number(p.mid ?? 1);
  const fc = Number(p.fc ?? 25);
  const elm = Number(p.elm_size ?? 25);
  const omega = Number(p.omega ?? 0.5);
  const rho = Number(p.rho ?? 0.0023);

  const MPA = 0.00689476; // psi -> MPa
  const INCH = 25.4;

  const fc_psi = fc / MPA;
  const phr = 0.16;

  const agg_size_in = 0.5;
  const W_mm = (3 * agg_size_in) * INCH;

  const ftm = 6.7 * Math.sqrt(Math.abs(fc_psi));
  const ft_out = ftm * MPA;

  const fc_old = 6580;
  const r = fc_psi / fc_old;

  const a0m = 1945, a1m = 0.4463, a2m = 1.228e-5;
  const a0y = 1469, a1y = 0.6250, a2y = 3.913e-5;

  const a0mn = (a0m * r) * MPA;
  const a1mn = a1m;
  const a2mn = (a2m / r) / MPA;

  const a0yn = (a0y * r) * MPA;
  const a1yn = a1y;
  const a2yn = (a2y / r) / MPA;

  const a1fn = a1mn;
  const a2fn = a2mn;

  const b1 = 1.6;
  const b3 = 1.15;

  const W_in = 3 * agg_size_in;
  const b2 =
    (0.09 * (W_in ** 2) - 0.98 * W_in + 3.06) *
    (1 - 0.004 * ((fc_psi / 1000) ** 2) + 0.097 * (fc_psi / 1000) - 0.484);

  const lambda_default = [0, 8e-6, 2.4e-5, 4e-5, 5.6e-5, 7.2e-5, 1e-4, 1e-3, 3e-3, 5e-3, 1, 10, 1e10];
  const eta_default = [0, 0.85, 0.97, 0.99, 1, 0.99, 0.97, 0.5, 0.1, 0, 0, 0, 0];

  const lcrate = 1000 + mid;
  const eosid = lcrate;

  const fco = 1450;
  const esco = 3e-5;
  const alphaD = 1 / (5 + 9 * fc_psi / fco);
  const gamma = 10 ** (6.156 * alphaD - 2);

  const esc = [0, 3e-5, 1e-4, 1e-3, 1e-2, 1e-1, 1, 3, 10, 30, 100, 300, 3e5];
  const est = [3e4, 3e2, 1e2, 3e1, 1e1, 3, 1, 1e-1, 1e-2, 1e-3, 1e-4, 1e-5];
  const es = [...est.map(v => -v), ...esc];
  const DIF = new Array(es.length).fill(0);

  for (let i = est.length; i < est.length + esc.length; i++) {
    const val = esc[i - est.length];
    DIF[i] = (val <= 1e5) ? (val / esco) ** (1.026 * alphaD) : gamma * (val / esco) ** (1 / 3);
  }
  DIF[est.length] = 1;

  const esto = 1e-6;
  const delta = 1 / (1 + 8 * fc_psi / fco);
  const beta = 10 ** (6 * delta - 2);
  for (let i = 0; i < est.length; i++) {
    const val = est[i];
    DIF[i] = (val <= 1.0) ? (val / esto) ** delta : beta * (val / esto) ** (1 / 3);
  }

  const ev = [0, -1.5e-3, -4.3e-3, -1.01e-2, -3.05e-2, -5.13e-2, -7.26e-2, -9.43e-2, -1.74e-1, -2.08e-1];
  const Pv = [0, 3.39976496e3, 7.41148762e3, 1.18991774e4, 2.26084370e4, 3.40996426e4, 4.83786555e4, 7.40128833e4, 4.32110127e5, 6.60914309e5].map(x => x * MPA);
  const Kun = [2.26650998e6, 2.26650998e6, 2.29824112e6, 2.41383313e6, 2.87166814e6, 3.33176967e6, 3.78960468e6, 4.13638071e6, 9.30628996e6, 1.13325499e7].map(x => x * MPA);

  let k = "";
  k += "*KEYWORD\n";
  k += `$ Generated by LS-DYNA Material Hub\n`;
  k += `$ Generator: mat072r3_kcc_rel3\n`;
  k += `$ Units: mm-ms-g-N-MPa\n$\n`;

  k += "*MAT_CONCRETE_DAMAGE_REL3_TITLE\n";
  k += `KCC_Concrete_${fc}_MPa_element_size_${elm}mm\n`;
  k += "$#     mid        ro        pr\n";
  k += `${fmtInt(mid)}${fmtExp(rho, 3)}${padLeft(phr.toFixed(1), 10)}\n`;
  k += "$#      ft        a0        a1        a2        b1     omega       a1f\n";
  k += `${fmtExp(ft_out, 3)}${fmtExp(a0mn, 3)}${fmtExp(a1mn, 3)}${fmtExp(a2mn, 3)}${fmtExp(b1, 3)}${fmtExp(omega, 3)}${fmtExp(a1fn, 3)}\n`;
  k += "$# slambda      nout     edrop     rsize       ucf    lcrate  locwidth      npts\n";
  k += `${fmtInt(100)}${fmtInt(2)}${fmtInt(1)}${fmtExp(3.972e-2, 3)}${fmtExp(1.450e2, 3)}${fmtInt(lcrate)}${fmtExp(W_mm, 3)}${fmtInt(13)}\n`;

  k += "$# lambda1   lambda2   lambda3   lambda4   lambda5   lambda6   lambda7   lambda8\n";
  k += lambda_default.slice(0, 8).map(v => fmtExp(v, 3)).join("") + "\n";
  k += "$#lambda09  lambda10  lambda11  lambda12  lambda13        b3       a0y       a1y\n";
  k += lambda_default.slice(8).map(v => fmtExp(v, 3)).join("") + fmtExp(b3, 3) + fmtExp(a0yn, 3) + fmtExp(a1yn, 3) + "\n";

  k += "$#    eta1      eta2      eta3      eta4      eta5      eta6      eta7      eta8\n";
  k += eta_default.slice(0, 8).map(v => fmtExp(v, 3)).join("") + "\n";
  k += "$#   eta09     eta10     eta11     eta12     eta13        b2       a2f       a2y\n";
  k += eta_default.slice(8).map(v => fmtExp(v, 3)).join("") + fmtExp(b2, 3) + fmtExp(a2fn, 3) + fmtExp(a2yn, 3) + "\n";

  k += "$\n*DEFINE_CURVE_TITLE\n";
  k += "Dynamic Impact Factors for Tension and Compression\n";
  k += "$#    lcid      sidr       sfa       sfo      offa      offo    dattyp\n";
  k += `${fmtInt(lcrate)}${fmtInt(0)}${fmtInt(1)}${fmtInt(1)}${fmtInt(0)}${fmtInt(0)}${fmtInt(0)}\n`;
  k += "$#                a1                  o1\n";
  for (let i = 0; i < es.length; i++) k += `${padLeft(es[i].toExponential(3).replace("e","E"),20)}${padLeft(DIF[i].toExponential(3).replace("e","E"),20)}\n`;

  k += "$\n*EOS_TABULATED_COMPACTION\n";
  k += "$    EOSID     GAMMA        E0        V0\n";
  k += `${fmtInt(eosid)}${fmtExp(0, 3)}${fmtExp(0, 3)}${fmtExp(1, 3)}\n`;
  k += "$           EV01            EV02            EV03            EV04            EV05\n";
  k += ` ${ev.slice(0, 5).map(v => padLeft(v.toExponential(8).replace("e","E"),12)).join(" ")}\n`;
  k += "$           EV06            EV07            EV08            EV09            EV10\n";
  k += ` ${ev.slice(5, 10).map(v => padLeft(v.toExponential(8).replace("e","E"),12)).join(" ")}\n`;
  k += "$            P01             P02             P03             P04             P05\n";
  k += ` ${Pv.slice(0, 5).map(v => padLeft(v.toExponential(8).replace("e","E"),12)).join(" ")}\n`;
  k += "$            P06             P07             P08             P09             P10\n";
  k += ` ${Pv.slice(5, 10).map(v => padLeft(v.toExponential(8).replace("e","E"),12)).join(" ")}\n`;
  k += "$            T01             T02             T03             T04             T05\n";
  k += ` ${[0,0,0,0,0].map(v => padLeft(v.toExponential(8).replace("e","E"),12)).join(" ")}\n`;
  k += "$            T06             T07             T08             T09             T10\n";
  k += ` ${[0,0,0,0,0].map(v => padLeft(v.toExponential(8).replace("e","E"),12)).join(" ")}\n`;
  k += "$            K01             K02             K03             K04             K05\n";
  k += ` ${Kun.slice(0, 5).map(v => padLeft(v.toExponential(8).replace("e","E"),12)).join(" ")}\n`;
  k += "$            K06             K07             K08             K09             K10\n";
  k += ` ${Kun.slice(5, 10).map(v => padLeft(v.toExponential(8).replace("e","E"),12)).join(" ")}\n`;

  k += "$\n*END\n";
  return k;
}
