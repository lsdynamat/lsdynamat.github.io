// assets/js/generators/mat273_cdp.js
// CDP (LS-DYNA *MAT_CONCRETE_DAMAGE_PLASTIC_MODEL) — MAT_273
// LS-PrePost V4.8.17 card order (3 numeric lines)
// Units: mm-ms-g-N-MPa
//
// ✅ Minimal inputs only (everything else uses defaults):
// - MID (required)
// - FC (required)
// - Confinement dropdown: cover/core (auto EFC)
// - FT method dropdown: auto/manual
// - FT manual (only used if manual)
// Optional advanced overrides (kept but hidden-ish): ECC, WF, EFC (if you want to force)
//   -> If you really don't want these, delete those 3 fields below.

export const KEY = "mat273_cdp";
export const ID = 273;
export const NAME = "CDP Concrete (*MAT_CONCRETE_DAMAGE_PLASTIC_MODEL)";
export const CATEGORY = "Concrete";
export const UNITS = "mm-ms-g-N-MPa";

const HUB_LINE = "$ Generated by LS DYNA Material Hub http://lsdynamat.github.io";
const UNITS_LINE = "$ Units: mm-ms-g-N-MPa";
const MODEL_LINE = "$ Model: CDP - *MAT_CONCRETE_DAMAGE_PLASTIC_MODEL (MAT_273)";

const MATERIAL_CARDS_BANNER = [
  "$ --+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8",
  "$                                                                              $",
  "$                                MATERIAL CARDS                                $",
  "$                                                                              $",
  "$ --+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8",
];

// ------------------------
// Defaults (NOT exposed as inputs unless you add fields)
// ------------------------
const DEFAULTS = {
  // Elastic (typical)
  ro: 0.0024,     // g/mm^3
  E: 30000.0,     // MPa
  pr: 0.20,

  // Manual/keyword defaults (good general starting point)
  qh0: 0.30,
  type: 1.0,      // bi-linear damage recommended
  bs: 1.0,
  strflg: 0.0,    // quasi-static
  failflg: 0.0,   // no erosion (recommended for cyclic)

  // 2nd line (keep default as-is unless you know what you're doing)
  // If STRFLG=0 -> HP=0.01; if STRFLG=1 -> HP=0.5
  hp_qs: 0.01,
  hp_rate: 0.5,
  ah: 0.08,
  bh: 0.003,
  ch: 2.0,
  dh: 1.0e-6,
  as: 15.0,
  df: 0.85,
  fc0: 0.0,
};

// Dropdown options (UI)
const CONFINEMENT_OPTIONS = [
  { value: "cover", label: "Non-confined (Cover)" },
  { value: "core", label: "Confined (Core)" },
];
const FT_METHOD_OPTIONS = [
  { value: "auto_ec2", label: "Auto (EC2/fib function)" },
  { value: "manual", label: "Manual input" },
];

// ✅ Minimal fields only
export const FIELDS = [
  { key: "mid", label: "Material ID (MID)", unit: "-", default: 1, min: 1, hint: "Unique positive integer" },

  { key: "fc", label: "Compressive strength FC", unit: "MPa", default: 30.0, min: 1, hint: "f'c in MPa" },

  {
    key: "confinement",
    label: "Confinement",
    unit: "-",
    default: "cover",
    kind: "select",
    options: CONFINEMENT_OPTIONS,
    hint: "cover -> EFC=0.005, core -> EFC=0.010",
  },

  {
    key: "ftMethod",
    label: "FT method",
    unit: "-",
    default: "auto_ec2",
    kind: "select",
    options: FT_METHOD_OPTIONS,
    hint: "Auto computes FT from FC; Manual uses FT_manual below",
  },

  { key: "ft_manual", label: "FT (manual)", unit: "MPa", default: 2.9, min: 0.001, hint: "Used only if FT method=Manual" },

  // --- Optional advanced overrides (if you want to force)
  // If you truly don't want advanced inputs, delete these 3 entries:
  { key: "ecc_override", label: "ECC override (optional)", unit: "-", default: "", hint: "Leave blank = auto" },
  { key: "wf_override", label: "WF override (optional)", unit: "mm", default: "", hint: "Leave blank = auto" },
  { key: "efc_override", label: "EFC override (optional)", unit: "-", default: "", hint: "Leave blank = auto from confinement" },
];

export function generate(input = {}) {
  const inp = { ...normalizeInput(input) };

  // Required
  const mid = mustIntPositive("mid", inp.mid);
  const fc = mustPositive("fc", inp.fc);

  // Dropdowns
  const confinement = normalizeConfinement(inp.confinement);
  const ftMethod = normalizeFtMethod(inp.ftMethod);
  const isCore = confinement === "core";

  // FT
  const ft =
    ftMethod === "manual"
      ? mustPositive("ft_manual", inp.ft_manual)
      : calculate_ft_ec2(fc);

  // ECC (auto unless overridden)
  const ecc =
    hasValue(inp.ecc_override)
      ? mustPositive("ecc_override", inp.ecc_override)
      : computeEccentricity(fc, ft);

  // WF (auto unless overridden)
  const wf =
    hasValue(inp.wf_override)
      ? mustPositive("wf_override", inp.wf_override)
      : computeWfFromPaper(fc, ft);

  // Bi-linear defaults (manual)
  const wf1 = 0.15 * wf;
  const ft1 = 0.3 * ft;

  // EFC (auto from confinement unless overridden)
  const efc =
    hasValue(inp.efc_override)
      ? mustPositive("efc_override", inp.efc_override)
      : (isCore ? 0.010 : 0.005);

  // Fixed defaults (not exposed as inputs)
  const ro = DEFAULTS.ro;
  const E = DEFAULTS.E;
  const pr = DEFAULTS.pr;

  const qh0 = DEFAULTS.qh0;
  const type = DEFAULTS.type;
  const bs = DEFAULTS.bs;
  const strflg = DEFAULTS.strflg;
  const failflg = DEFAULTS.failflg;

  const hp = (strflg >= 0.5) ? DEFAULTS.hp_rate : DEFAULTS.hp_qs;
  const ah = DEFAULTS.ah;
  const bh = DEFAULTS.bh;
  const ch = DEFAULTS.ch;
  const dh = DEFAULTS.dh;
  const as = DEFAULTS.as;
  const df = DEFAULTS.df;
  const fc0 = DEFAULTS.fc0;

  const tag = isCore ? "CORE(confined)" : "COVER(unconfined)";
  const ftTag = ftMethod === "manual" ? "FT=manual" : "FT=auto(EC2)";
  const titleLine = `MAT_273 CDP fc=${toFixed(fc, 1)}MPa, ft=${toFixed(ft, 3)}MPa (${ftTag}), ${tag}`;

  // Keyword
  const lines = [];
  lines.push("$# LS-DYNA Keyword file created by LS-PrePost");
  lines.push("*KEYWORD");
  MATERIAL_CARDS_BANNER.forEach(s => lines.push(s));

  lines.push("*MAT_CONCRETE_DAMAGE_PLASTIC_MODEL_TITLE");
  lines.push(titleLine);

  lines.push(UNITS_LINE);
  lines.push(MODEL_LINE);
  lines.push(HUB_LINE);

  lines.push("$#     MID        RO         E        PR       ECC       QH0        FT        FC");
  lines.push(
    `${fmt10(mid)}` +
    `${fmt10(ro, 7)}` +
    `${fmt10(E, 1)}` +
    `${fmt10(pr, 2)}` +
    `${fmt10(ecc, 6)}` +
    `${fmt10(qh0, 3)}` +
    `${fmt10(ft, 6)}` +
    `${fmt10(fc, 6)}`
  );

  lines.push("$#      HP        AH        BH        CH        DH        AS        DF       FC0");
  lines.push(
    `${fmt10(hp, 6)}` +
    `${fmt10(ah, 6)}` +
    `${fmt10(bh, 6)}` +
    `${fmt10(ch, 6)}` +
    `${fmt10(dh, 6)}` +
    `${fmt10(as, 6)}` +
    `${fmt10(df, 6)}` +
    `${fmt10(fc0, 6)}`
  );

  lines.push("$#    TYPE        BS        WF       WF1       FT1    STRFLG   FAILFLG       EFC");
  lines.push(
    `${fmt10(type, 6)}` +
    `${fmt10(bs, 6)}` +
    `${fmt10(wf, 6)}` +
    `${fmt10(wf1, 6)}` +
    `${fmt10(ft1, 6)}` +
    `${fmt10(strflg, 1)}` +
    `${fmt10(failflg, 6)}` +
    `${fmt10(efc, 6)}`
  );

  lines.push("*END");
  lines.push("");

  const filename = `MAT_273_CDP_fc=${toFixed(fc, 1)}MPa_${confinement}_${ftMethod}_mid=${mid}.k`;
  return { filename, keyword: lines.join("\n") };
}

// ------------------------
// FT auto (your function)
// ------------------------
function calculate_ft_ec2(fc) {
  if (fc <= 50) return 0.3 * Math.pow(fc, 2 / 3);
  return 2.12 * Math.log(1 + 0.1 * (fc + 8));
}

// ------------------------
// Paper formulas used in your workflow
// ------------------------
function computeEccentricity(fc, ft) {
  const fbc = 1.16 * fc;
  const denom = fbc * (fc * fc - ft * ft);
  if (Math.abs(denom) < 1e-12) throw new Error("ECC denominator ~0; check fc/ft values.");
  return (ft * (fbc * fbc - ft * ft)) / denom;
}

function computeGfFromPaper(fc) {
  return 73.0 * Math.pow(fc, 0.18); // treated as N/mm in mm–MPa convention
}

function computeWfFromPaper(fc, ft) {
  const Gf = computeGfFromPaper(fc);
  return (4.444 * Gf) / ft; // mm
}

// ------------------------
// Helpers
// ------------------------
function normalizeConfinement(x) {
  const v = (x ?? "").toString().trim().toLowerCase();
  if (v === "core" || v === "confined") return "core";
  return "cover";
}

function normalizeFtMethod(x) {
  const v = (x ?? "").toString().trim().toLowerCase();
  if (v === "manual") return "manual";
  return "auto_ec2";
}

function normalizeInput(obj) {
  const out = { ...obj };
  for (const k of Object.keys(out)) if (out[k] === "") out[k] = undefined;
  return out;
}

function hasValue(x) {
  return x !== undefined && x !== null && String(x).trim() !== "";
}

function mustPositive(name, x) {
  const v = Number(x);
  if (!Number.isFinite(v)) throw new Error(`${name} must be a number`);
  if (v <= 0) throw new Error(`${name} must be > 0`);
  return v;
}

function mustIntPositive(name, x) {
  const v = Number(x);
  if (!Number.isFinite(v)) throw new Error(`${name} must be a number`);
  const vi = Math.trunc(v);
  if (vi <= 0) throw new Error(`${name} must be an integer > 0`);
  return vi;
}

function toFixed(x, n) {
  const v = Number(x);
  if (!Number.isFinite(v)) return String(x);
  return v.toFixed(n);
}

// 10-char alignment like LS-PrePost blocks
function fmt10(x, decimals = 6) {
  if (Number.isInteger(x)) return String(x).padStart(10, " ");
  const v = Number(x);
  if (!Number.isFinite(v)) return String(x).padStart(10, " ");
  const av = Math.abs(v);
  if (av !== 0 && (av >= 1e6 || av < 1e-4)) {
    return v.toExponential(3).replace("e", "E").padStart(10, " ");
  }
  return v.toFixed(decimals).padStart(10, " ");
}
