// assets/js/generators/mat084_winfrith.js
// Winfrith Concrete Generator (LS-DYNA *MAT_WINFRITH_CONCRETE, MAT_084)
// Ported from your Python "source of truth".
// Units: mm-ms-g-N-MPa

export const KEY = "mat084_winfrith";
export const ID = 84;
export const NAME = "Winfrith Concrete (*MAT_WINFRITH_CONCRETE)";
export const CATEGORY = "Concrete";
export const UNITS = "mm-ms-g-N-MPa";

const UNITS_LINE = "$ Units: mm-ms-g-N-MPa";
const HUB_LINE = "$ Generated by LS-DYNA Material Hub http://lsdynamat.github.io";

// Optional “banner” like your screenshot
const MATERIAL_CARDS_BANNER = [
  "$ --+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8",
  "$                                                                              $",
  "$                                MATERIAL CARDS                                $",
  "$                                                                              $",
  "$ --+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8",
];

export const DEFAULTS = {
  mid: 99,
  ro: 0.0023,
  pr: 0.2,
  fc: 30.0,     // MPa (UCS)
  dmax: 16.0,   // mm (aggregate size)
  rate: 1.0,
  conm: -3.0,
  conl: 0.0,
  cont: 0.0
};

// (optional metadata for future auto-form)
export const FIELDS = [
  { key: "mid",  label: "Material ID (MID)",            unit: "-",       default: DEFAULTS.mid,  min: 1, hint: "Example: 99" },
  { key: "ro",   label: "Density (RO)",                 unit: "g/mm^3",   default: DEFAULTS.ro,   min: 1e-9, hint: "Typical: 0.0022–0.0024" },
  { key: "pr",   label: "Poisson ratio (PR)",           unit: "-",       default: DEFAULTS.pr,   min: 0.0, max: 0.49, hint: "Typical: 0.20" },
  { key: "fc",   label: "Compressive strength (f_c)",   unit: "MPa",     default: DEFAULTS.fc,   min: 1, hint: "Example: 30.0" },
  { key: "dmax", label: "Max aggregate size (d_max)",   unit: "mm",      default: DEFAULTS.dmax, min: 1, hint: "Example: 16" },
];

export function generate(input = {}) {
  const inp = { ...DEFAULTS, ...normalizeInput(input) };

  const mid  = mustIntPositive("mid", inp.mid);
  const ro   = mustPositive("ro", inp.ro);
  const pr   = mustInRange("pr", inp.pr, 0.0, 0.49);
  const fc   = mustPositive("fc", inp.fc);
  const dmax = mustPositive("dmax", inp.dmax);

  // Ported from Python logic
  const tm = calculate_tm(fc);
  const uts = calculate_ft(fc);
  const fe = calculate_wc(fc, dmax);
  const asize = dmax / 2.0;

  // Other constants (match your Python defaults)
  const e = 0.0, ys = 0.0, eh = 0.0, uelong = 0.0;
  const rate = Number.isFinite(Number(inp.rate)) ? Number(inp.rate) : DEFAULTS.rate;
  const conm = Number.isFinite(Number(inp.conm)) ? Number(inp.conm) : DEFAULTS.conm;
  const conl = Number.isFinite(Number(inp.conl)) ? Number(inp.conl) : DEFAULTS.conl;
  const cont = Number.isFinite(Number(inp.cont)) ? Number(inp.cont) : DEFAULTS.cont;

  const eps = Array(8).fill(0.0);
  const p = Array(8).fill(0.0);

  const title = `WINFRITH_Concrete_${toFixed(fc, 1)}MPa_dmax_${toFixed(dmax, 0)}mm`;

  const lines = [];
  lines.push("$# LS-DYNA Keyword file created by LS-PrePost(R)");
  lines.push(UNITS_LINE);
  lines.push(HUB_LINE);
  lines.push("*KEYWORD");

  // Optional banner
  MATERIAL_CARDS_BANNER.forEach(s => lines.push(s));

  lines.push("*MAT_WINFRITH_CONCRETE_TITLE");
  lines.push(title);

  lines.push("$#     mid        ro        tm        pr       ucs       uts        fe     asize");
  lines.push(
    `${fmt10(mid)}` +
    `${fmt10(ro, 4)}` +
    `${fmt10(tm, 1)}` +
    `${fmt10(pr, 1)}` +
    `${fmt10(fc, 1)}` +
    `${fmt10(uts, 3)}` +
    `${fmt10(fe, 3)}` +
    `${fmt10(asize, 1)}`
  );

  lines.push("$#      e        ys        eh    uelong      rate      conm      conl      cont");
  lines.push(
    `${fmt10(e, 1)}` +
    `${fmt10(ys, 1)}` +
    `${fmt10(eh, 1)}` +
    `${fmt10(uelong, 1)}` +
    `${fmt10(rate, 1)}` +
    `${fmt10(conm, 1)}` +
    `${fmt10(conl, 1)}` +
    `${fmt10(cont, 3)}`
  );

  lines.push("$#    eps1      eps2      eps3      eps4      eps5      eps6      eps7      eps8");
  lines.push(eps.map(v => fmt10(v, 1)).join(""));

  lines.push("$#      p1        p2        p3        p4        p5        p6        p7        p8");
  lines.push(p.map(v => fmt10(v, 1)).join(""));

  lines.push("*END");
  return lines.join("\n");
}

// --------------------
// Math ported from Python
function calculate_tm(fc) {
  const Ec0 = 21.5e3; // MPa
  const delta_f = 8.0;
  const fcm0 = 10.0;
  return Ec0 * Math.pow((fc + delta_f) / fcm0, 1 / 3);
}

function calculate_ft(fc) {
  if (fc <= 50) {
    return 0.3 * Math.pow(fc, 2 / 3);
  }
  return 2.12 * Math.log(1 + 0.1 * (fc + 8));
}

function calculate_gf0(dmax) {
  return 0.021 + 5.357e-4 * dmax;
}

function calculate_gf(fc, dmax) {
  const fcm = fc + 8;
  const fcm0 = 10;
  const gf0 = calculate_gf0(dmax);
  return gf0 * Math.pow(fcm / fcm0, 0.7);
}

function calculate_wc(fc, dmax) {
  const ft = calculate_ft(fc);
  const gf = calculate_gf(fc, dmax);
  return (2 * gf) / ft;
}

// --------------------
// Helpers
function normalizeInput(obj) {
  const out = { ...obj };
  for (const k of Object.keys(out)) if (out[k] === "") out[k] = undefined;
  return out;
}

function mustPositive(name, x) {
  const v = Number(x);
  if (!Number.isFinite(v)) throw new Error(`${name} must be a number`);
  if (v <= 0) throw new Error(`${name} must be > 0`);
  return v;
}
function mustIntPositive(name, x) {
  const v = Number(x);
  if (!Number.isFinite(v)) throw new Error(`${name} must be a number`);
  const vi = Math.trunc(v);
  if (vi <= 0) throw new Error(`${name} must be an integer > 0`);
  return vi;
}
function mustInRange(name, x, lo, hi) {
  const v = Number(x);
  if (!Number.isFinite(v)) throw new Error(`${name} must be a number`);
  if (v < lo || v > hi) throw new Error(`${name} must be in [${lo}, ${hi}]`);
  return v;
}
function toFixed(x, n) {
  const v = Number(x);
  if (!Number.isFinite(v)) return String(x);
  return v.toFixed(n);
}
function fmt10(x, decimals = 6) {
  if (Number.isInteger(x)) return String(x).padStart(10, " ");
  const v = Number(x);
  if (!Number.isFinite(v)) return String(x).padStart(10, " ");
  const av = Math.abs(v);
  if (av !== 0 && (av >= 1e6 || av < 1e-4)) {
    return v.toExponential(3).replace("e", "E").padStart(10, " ");
  }
  return v.toFixed(decimals).padStart(10, " ");
}
